<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>离屏canvas,创建放大镜</title>
	<style>
	    body{
	    	background: #000;
	    }
		#canvas{
			display: block;
			margin: 0 auto;
			border:1px solid #aaa;
		}
		.range{
			width: 400px;
			margin:30px auto;
			display: block;
		}
	</style>
</head>
<body>
	<canvas id='canvas'>
		您的浏览器尚不支持canvas
	</canvas>
	<canvas id='offCanvas' style='display: none'></canvas>
	<input class='range' id='scale_range' type="range" min='0.1' max='3.0' step='0.01' value='1.0'/>
	<script>
		var canvas = document.getElementById('canvas');
		var context = canvas.getContext('2d');
		var offCanvas = document.getElementById('offCanvas');
		var offContext = offCanvas.getContext('2d');//上下文环境
		var img = new Image();
		var isMouseDown = false;
		window.onload = function(){
			img.src = '1.jpg';
			canvas.width = 500;
			canvas.height = 300;
			//当图片正式读取完成后在进行调用
			img.onload = function(){
				offCanvas.width=img.width;
				offCanvas.height = img.height;
				scale = offCanvas.width/canvas.width;
				context.drawImage(img,0,0,canvas.width,canvas.height);
			    offContext.drawImage(img,0,0);
			}

		}
		function windowToCanvas(x,y){
			var bbox = canvas.getBoundingClientRect();
			return {
				x:x-bbox.left,
				y:y-bbox.top
			}

		}
		canvas.onmousedown = function(e){
			e.preventDefault();

			var point = windowToCanvas(e.clientX,e.clientY);
			isMouseDown = true;
			drawCanvas(true,point);

		}
		canvas.onmousemove = function(e){
			e.preventDefault();
			if(isMouseDown==true){
               var point =windowToCanvas(e.clientX,e.clientY);
               drawCanvas(true,point);
			}
		}
		canvas.onmouseup = function(e){
			e.preventDefault();
			isMouseDown = false;
			drawCanvas(false);
		}
		canvas.onmouseout = function(e){
			e.preventDefault();
			isMouseDown = false;
		}
		function drawCanvas(isShow,point){
			context.clearRect(0,0,canvas.width,canvas.height);
			context.drawImage(img,0,0,canvas.width,canvas.height);
			if(isShow == true){
				drawMagnifier(point);
			}
		}
		function drawMagnifier(point){
			var image_x = point.x *scale;
			var image_y = point.y * scale;
			var mr = 100;
			var sx = image_x - mr;
			var sy = image_y - mr;
			var dx = point.x - mr;
			var dy = point.y - mr;
			context.drawImage(offCanvas,sx,sy,2*mr,2*mr,dx,dy,2*mr,2*mr);
		}
	</script>
</body>
</html>